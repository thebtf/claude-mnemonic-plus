# Engram â€” Server Stack
#
# Provides: PostgreSQL + pgvector, Engram Server (API + MCP SSE on single port)
# Client (hooks + MCP proxy) runs locally on each workstation.
#
# Usage:
#   cp .env.example .env   # edit with your settings
#   docker compose up -d
#
# See docs/DEPLOYMENT.md for full setup instructions.

services:
  postgres:
    image: pgvector/pgvector:pg17
    environment:
      POSTGRES_DB: engram
      POSTGRES_USER: engram
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-engram}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U engram -d engram"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Worker with integrated MCP SSE (single port, single process)
  server:
    build:
      context: .
      target: server
    ports:
      - "${WORKER_PORT:-37777}:37777"
    environment:
      DATABASE_DSN: "postgres://engram:${POSTGRES_PASSWORD:-engram}@postgres:5432/engram?sslmode=disable"
      ENGRAM_WORKER_HOST: "0.0.0.0"
      ENGRAM_WORKER_PORT: "37777"
      ENGRAM_API_TOKEN: "${API_TOKEN:-}"
      ENGRAM_EMBEDDING_PROVIDER: "${EMBEDDING_PROVIDER:-openai}"
      ENGRAM_EMBEDDING_BASE_URL: "${EMBEDDING_BASE_URL:-}"
      ENGRAM_EMBEDDING_API_KEY: "${EMBEDDING_API_KEY:-}"
      ENGRAM_EMBEDDING_MODEL_NAME: "${EMBEDDING_MODEL_NAME:-}"
      ENGRAM_EMBEDDING_DIMENSIONS: "${EMBEDDING_DIMENSIONS:-4096}"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  pgdata:
